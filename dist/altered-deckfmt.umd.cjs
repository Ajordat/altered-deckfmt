(function(k,F){typeof exports=="object"&&typeof module<"u"?F(exports):typeof define=="function"&&define.amd?define(["exports"],F):(k=typeof globalThis<"u"?globalThis:k||self,F(k.deckfmt={}))})(this,function(k){"use strict";var rt=Object.defineProperty;var it=(k,F,T)=>F in k?rt(k,F,{enumerable:!0,configurable:!0,writable:!0,value:T}):k[F]=T;var B=(k,F,T)=>it(k,typeof F!="symbol"?F+"":F,T);var F=(p=>(p.Axiom="AX",p.Bravos="BR",p.Lyra="LY",p.Muna="MU",p.Ordis="OR",p.Yzmir="YZ",p.Neutral="NE",p))(F||{}),T=(p=>(p.Common="C",p.Rare="R1",p.RareOOF="R2",p.Unique="U",p))(T||{}),Z=(p=>(p.CoreKS="COREKS",p.Core="CORE",p))(Z||{});class oe{constructor(n){B(this,"set_code");B(this,"b_p");B(this,"faction");B(this,"num_in_faction");B(this,"rarity");B(this,"uniq_num");const s=n.match(/^ALT_(\w+)_(B|P)_(\w{2})_(\d{1,2})_(C|R1|R2|U)(?:_(\d+))?$/);if(!s)throw"unrecognized card id";if(this.set_code=s[1],this.b_p=s[2]=="B"?0:1,this.faction=s[3],this.num_in_faction=parseInt(s[4],10),this.rarity=s[5],this.uniq_num=s[6]?parseInt(s[6]):void 0,this.rarity=="U"&&this.uniq_num==null)throw"unique card is missing a unique_number"}get factionId(){switch(this.faction){case"AX":return 1;case"BR":return 2;case"LY":return 3;case"MU":return 4;case"OR":return 5;case"YZ":return 6;case"NE":return 7}throw`Unrecognized Faction ${this.faction}`}get rarityId(){switch(this.rarity){case"C":return 0;case"R1":return 1;case"R2":return 2;case"U":return 3}throw`Unrecognized Rarity ${this.rarity}`}get setId(){switch(this.set_code){case"COREKS":return 1;case"CORE":return 2}throw`Unrecognized SetCode ${this.rarity}`}}class G{constructor(){B(this,"setCode");B(this,"faction");B(this,"numberInFaction");B(this,"rarity");B(this,"uniqueId")}static decode(n,s){const u=new G;if(s.setCode===void 0)throw new V("Tried to decode Card without SetCode in context");if(u.setCode=s.setCode,u.faction=n.readSync(3),u.faction==0)throw new V(`Invalid faction ID (${u.faction})`);return u.numberInFaction=n.readSync(5),u.rarity=n.readSync(2),u.rarity==3&&(u.uniqueId=n.readSync(16)),u}encode(n){if(n.write(3,this.faction),n.write(5,this.numberInFaction),n.write(2,this.rarity),this.uniqueId!==void 0){if(this.uniqueId>65535)throw new v("Cannot encode unique ID greater than 65535");n.write(16,this.uniqueId)}}get asCardId(){let n="ALT_";switch(this.setCode){case 1:n+=Z.CoreKS;break;case 2:n+=Z.Core;break}switch(n+="_B_",this.faction){case 1:n+=F.Axiom;break;case 2:n+=F.Bravos;break;case 3:n+=F.Lyra;break;case 4:n+=F.Muna;break;case 5:n+=F.Ordis;break;case 6:n+=F.Yzmir;break;case 7:n+=F.Neutral;break}switch(n+="_",this.numberInFaction<10&&this.faction!=7&&(n+="0"),n+=this.numberInFaction,n+="_",this.rarity){case 0:n+=T.Common;break;case 1:n+=T.Rare;break;case 2:n+=T.RareOOF;break;case 3:n+=T.Unique+"_"+this.uniqueId;break}return n}static fromId(n){let s=new G,u=new oe(n);return s.setCode=u.setId,s.faction=u.factionId,s.numberInFaction=u.num_in_faction,s.rarity=u.rarityId,s.uniqueId=u.uniq_num,s}}class Y{constructor(){B(this,"quantity");B(this,"card")}static decode(n,s){const u=new Y,c=n.readSync(2);if(c>0)u.quantity=c;else{const l=n.readSync(6);u.quantity=l==0?0:l+3}return u.card=G.decode(n,s),u}encode(n){if(this.quantity>0&&this.quantity<=3)n.write(2,this.quantity);else if(this.quantity>3){if(this.quantity>65)throw new v(`Cannot encode card quantity (${this.quantity}) greater than 65`);n.write(2,0),n.write(6,this.quantity-3)}else n.write(8,0);this.card.encode(n)}get asCardRefQty(){return{quantity:this.quantity,id:this.card.asCardId}}static from(n,s){let u=new Y;return u.quantity=n,u.card=G.fromId(s),u}}class Q{constructor(){B(this,"setCode");B(this,"cardQty")}static decode(n,s){const u=new Q;if(u.setCode=n.readSync(8),u.setCode==0)throw new V(`Invalid SetCode ID (${u.setCode})`);s.setCode=u.setCode;const c=n.readSync(6),l=new Array;for(let d=0;d<c;d++)l.push(Y.decode(n,s));return u.cardQty=l,s.setCode=void 0,u}encode(n){if(this.cardQty.length<=0)throw new v("Cannot encode a SetGroup with 0 cards");const s=this.cardQty[0].card.setCode;n.write(8,s),n.write(6,this.cardQty.length);for(let u of this.cardQty)u.encode(n)}static from(n){let s=new Q;return s.cardQty=n.map(u=>Y.from(u.quantity,u.id)),s}}class P{constructor(){B(this,"version");B(this,"setGroups")}static decode(n){const s=new P,u=new me;if(s.version=n.readSync(4),s.version!==1)throw new V(`Invalid version (${s.version}`);const c=n.readSync(8),l=new Array;for(let d=0;d<c;d++)l.push(Q.decode(n,u));return s.setGroups=l,s}encode(n){n.write(4,this.version),n.write(8,this.setGroups.length);for(let u of this.setGroups)u.encode(n);const s=8-n.offset%8;n.write(s,0)}get asCardRefQty(){return this.setGroups.reduce((n,s)=>n.concat(s.cardQty.map(u=>u.asCardRefQty)),Array())}static fromList(n){const s=P.groupedBySet(n).map(c=>Q.from(c));let u=new P;return u.version=1,u.setGroups=s,u}static groupedBySet(n){let s=new Map;for(let u of n){const c=new oe(u.id).set_code;let l=s.get(c);l||(l=[],s.set(c,l)),l.push(u)}return Array.from(s,([u,c])=>c)}}class me{constructor(){B(this,"setCode")}}class V extends Error{constructor(n){super(n),this.name="DecodingError"}}class v extends Error{constructor(n){super(n),this.name="EncodingError"}}var X={},K={};K.byteLength=_e,K.toByteArray=Ae,K.fromByteArray=Ce;for(var $=[],L=[],Ie=typeof Uint8Array<"u"?Uint8Array:Array,ee="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",D=0,Ee=ee.length;D<Ee;++D)$[D]=ee[D],L[ee.charCodeAt(D)]=D;L[45]=62,L[95]=63;function fe(p){var n=p.length;if(n%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var s=p.indexOf("=");s===-1&&(s=n);var u=s===n?0:4-s%4;return[s,u]}function _e(p){var n=fe(p),s=n[0],u=n[1];return(s+u)*3/4-u}function Fe(p,n,s){return(n+s)*3/4-s}function Ae(p){var n,s=fe(p),u=s[0],c=s[1],l=new Ie(Fe(p,u,c)),d=0,o=c>0?u-4:u,y;for(y=0;y<o;y+=4)n=L[p.charCodeAt(y)]<<18|L[p.charCodeAt(y+1)]<<12|L[p.charCodeAt(y+2)]<<6|L[p.charCodeAt(y+3)],l[d++]=n>>16&255,l[d++]=n>>8&255,l[d++]=n&255;return c===2&&(n=L[p.charCodeAt(y)]<<2|L[p.charCodeAt(y+1)]>>4,l[d++]=n&255),c===1&&(n=L[p.charCodeAt(y)]<<10|L[p.charCodeAt(y+1)]<<4|L[p.charCodeAt(y+2)]>>2,l[d++]=n>>8&255,l[d++]=n&255),l}function Ue(p){return $[p>>18&63]+$[p>>12&63]+$[p>>6&63]+$[p&63]}function Se(p,n,s){for(var u,c=[],l=n;l<s;l+=3)u=(p[l]<<16&16711680)+(p[l+1]<<8&65280)+(p[l+2]&255),c.push(Ue(u));return c.join("")}function Ce(p){for(var n,s=p.length,u=s%3,c=[],l=16383,d=0,o=s-u;d<o;d+=l)c.push(Se(p,d,d+l>o?o:d+l));return u===1?(n=p[s-1],c.push($[n>>2]+$[n<<4&63]+"==")):u===2&&(n=(p[s-2]<<8)+p[s-1],c.push($[n>>10]+$[n>>4&63]+$[n<<2&63]+"=")),c.join("")}var te={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */te.read=function(p,n,s,u,c){var l,d,o=c*8-u-1,y=(1<<o)-1,b=y>>1,x=-7,g=s?c-1:0,A=s?-1:1,U=p[n+g];for(g+=A,l=U&(1<<-x)-1,U>>=-x,x+=o;x>0;l=l*256+p[n+g],g+=A,x-=8);for(d=l&(1<<-x)-1,l>>=-x,x+=u;x>0;d=d*256+p[n+g],g+=A,x-=8);if(l===0)l=1-b;else{if(l===y)return d?NaN:(U?-1:1)*(1/0);d=d+Math.pow(2,u),l=l-b}return(U?-1:1)*d*Math.pow(2,l-u)},te.write=function(p,n,s,u,c,l){var d,o,y,b=l*8-c-1,x=(1<<b)-1,g=x>>1,A=c===23?Math.pow(2,-24)-Math.pow(2,-77):0,U=u?0:l-1,C=u?1:-1,M=n<0||n===0&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(o=isNaN(n)?1:0,d=x):(d=Math.floor(Math.log(n)/Math.LN2),n*(y=Math.pow(2,-d))<1&&(d--,y*=2),d+g>=1?n+=A/y:n+=A*Math.pow(2,1-g),n*y>=2&&(d++,y/=2),d+g>=x?(o=0,d=x):d+g>=1?(o=(n*y-1)*Math.pow(2,c),d=d+g):(o=n*Math.pow(2,g-1)*Math.pow(2,c),d=0));c>=8;p[s+U]=o&255,U+=C,o/=256,c-=8);for(d=d<<c|o,b+=c;b>0;p[s+U]=d&255,U+=C,d/=256,b-=8);p[s+U-C]|=M*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(p){const n=K,s=te,u=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;p.Buffer=o,p.SlowBuffer=Me,p.INSPECT_MAX_BYTES=50;const c=2147483647;p.kMaxLength=c,o.TYPED_ARRAY_SUPPORT=l(),!o.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function l(){try{const r=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(r,e),r.foo()===42}catch{return!1}}Object.defineProperty(o.prototype,"parent",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.buffer}}),Object.defineProperty(o.prototype,"offset",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.byteOffset}});function d(r){if(r>c)throw new RangeError('The value "'+r+'" is invalid for option "size"');const e=new Uint8Array(r);return Object.setPrototypeOf(e,o.prototype),e}function o(r,e,t){if(typeof r=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return g(r)}return y(r,e,t)}o.poolSize=8192;function y(r,e,t){if(typeof r=="string")return A(r,e);if(ArrayBuffer.isView(r))return C(r);if(r==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof r);if(N(r,ArrayBuffer)||r&&N(r.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(N(r,SharedArrayBuffer)||r&&N(r.buffer,SharedArrayBuffer)))return M(r,e,t);if(typeof r=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const i=r.valueOf&&r.valueOf();if(i!=null&&i!==r)return o.from(i,e,t);const f=Ne(r);if(f)return f;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof r[Symbol.toPrimitive]=="function")return o.from(r[Symbol.toPrimitive]("string"),e,t);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof r)}o.from=function(r,e,t){return y(r,e,t)},Object.setPrototypeOf(o.prototype,Uint8Array.prototype),Object.setPrototypeOf(o,Uint8Array);function b(r){if(typeof r!="number")throw new TypeError('"size" argument must be of type number');if(r<0)throw new RangeError('The value "'+r+'" is invalid for option "size"')}function x(r,e,t){return b(r),r<=0?d(r):e!==void 0?typeof t=="string"?d(r).fill(e,t):d(r).fill(e):d(r)}o.alloc=function(r,e,t){return x(r,e,t)};function g(r){return b(r),d(r<0?0:re(r)|0)}o.allocUnsafe=function(r){return g(r)},o.allocUnsafeSlow=function(r){return g(r)};function A(r,e){if((typeof e!="string"||e==="")&&(e="utf8"),!o.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const t=ue(r,e)|0;let i=d(t);const f=i.write(r,e);return f!==t&&(i=i.slice(0,f)),i}function U(r){const e=r.length<0?0:re(r.length)|0,t=d(e);for(let i=0;i<e;i+=1)t[i]=r[i]&255;return t}function C(r){if(N(r,Uint8Array)){const e=new Uint8Array(r);return M(e.buffer,e.byteOffset,e.byteLength)}return U(r)}function M(r,e,t){if(e<0||r.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(r.byteLength<e+(t||0))throw new RangeError('"length" is outside of buffer bounds');let i;return e===void 0&&t===void 0?i=new Uint8Array(r):t===void 0?i=new Uint8Array(r,e):i=new Uint8Array(r,e,t),Object.setPrototypeOf(i,o.prototype),i}function Ne(r){if(o.isBuffer(r)){const e=re(r.length)|0,t=d(e);return t.length===0||r.copy(t,0,0,e),t}if(r.length!==void 0)return typeof r.length!="number"||se(r.length)?d(0):U(r);if(r.type==="Buffer"&&Array.isArray(r.data))return U(r.data)}function re(r){if(r>=c)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+c.toString(16)+" bytes");return r|0}function Me(r){return+r!=r&&(r=0),o.alloc(+r)}o.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==o.prototype},o.compare=function(e,t){if(N(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),N(t,Uint8Array)&&(t=o.from(t,t.offset,t.byteLength)),!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let i=e.length,f=t.length;for(let h=0,a=Math.min(i,f);h<a;++h)if(e[h]!==t[h]){i=e[h],f=t[h];break}return i<f?-1:f<i?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return o.alloc(0);let i;if(t===void 0)for(t=0,i=0;i<e.length;++i)t+=e[i].length;const f=o.allocUnsafe(t);let h=0;for(i=0;i<e.length;++i){let a=e[i];if(N(a,Uint8Array))h+a.length>f.length?(o.isBuffer(a)||(a=o.from(a)),a.copy(f,h)):Uint8Array.prototype.set.call(f,a,h);else if(o.isBuffer(a))a.copy(f,h);else throw new TypeError('"list" argument must be an Array of Buffers');h+=a.length}return f};function ue(r,e){if(o.isBuffer(r))return r.length;if(ArrayBuffer.isView(r)||N(r,ArrayBuffer))return r.byteLength;if(typeof r!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof r);const t=r.length,i=arguments.length>2&&arguments[2]===!0;if(!i&&t===0)return 0;let f=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return t;case"utf8":case"utf-8":return ne(r).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return t*2;case"hex":return t>>>1;case"base64":return xe(r).length;default:if(f)return i?-1:ne(r).length;e=(""+e).toLowerCase(),f=!0}}o.byteLength=ue;function qe(r,e,t){let i=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((t===void 0||t>this.length)&&(t=this.length),t<=0)||(t>>>=0,e>>>=0,t<=e))return"";for(r||(r="utf8");;)switch(r){case"hex":return Ve(this,e,t);case"utf8":case"utf-8":return ce(this,e,t);case"ascii":return Qe(this,e,t);case"latin1":case"binary":return We(this,e,t);case"base64":return Ge(this,e,t);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Xe(this,e,t);default:if(i)throw new TypeError("Unknown encoding: "+r);r=(r+"").toLowerCase(),i=!0}}o.prototype._isBuffer=!0;function O(r,e,t){const i=r[e];r[e]=r[t],r[t]=i}o.prototype.swap16=function(){const e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)O(this,t,t+1);return this},o.prototype.swap32=function(){const e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)O(this,t,t+3),O(this,t+1,t+2);return this},o.prototype.swap64=function(){const e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)O(this,t,t+7),O(this,t+1,t+6),O(this,t+2,t+5),O(this,t+3,t+4);return this},o.prototype.toString=function(){const e=this.length;return e===0?"":arguments.length===0?ce(this,0,e):qe.apply(this,arguments)},o.prototype.toLocaleString=o.prototype.toString,o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:o.compare(this,e)===0},o.prototype.inspect=function(){let e="";const t=p.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},u&&(o.prototype[u]=o.prototype.inspect),o.prototype.compare=function(e,t,i,f,h){if(N(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),!o.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(t===void 0&&(t=0),i===void 0&&(i=e?e.length:0),f===void 0&&(f=0),h===void 0&&(h=this.length),t<0||i>e.length||f<0||h>this.length)throw new RangeError("out of range index");if(f>=h&&t>=i)return 0;if(f>=h)return-1;if(t>=i)return 1;if(t>>>=0,i>>>=0,f>>>=0,h>>>=0,this===e)return 0;let a=h-f,w=i-t;const E=Math.min(a,w),I=this.slice(f,h),_=e.slice(t,i);for(let m=0;m<E;++m)if(I[m]!==_[m]){a=I[m],w=_[m];break}return a<w?-1:w<a?1:0};function he(r,e,t,i,f){if(r.length===0)return-1;if(typeof t=="string"?(i=t,t=0):t>2147483647?t=2147483647:t<-2147483648&&(t=-2147483648),t=+t,se(t)&&(t=f?0:r.length-1),t<0&&(t=r.length+t),t>=r.length){if(f)return-1;t=r.length-1}else if(t<0)if(f)t=0;else return-1;if(typeof e=="string"&&(e=o.from(e,i)),o.isBuffer(e))return e.length===0?-1:ae(r,e,t,i,f);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?f?Uint8Array.prototype.indexOf.call(r,e,t):Uint8Array.prototype.lastIndexOf.call(r,e,t):ae(r,[e],t,i,f);throw new TypeError("val must be string, number or Buffer")}function ae(r,e,t,i,f){let h=1,a=r.length,w=e.length;if(i!==void 0&&(i=String(i).toLowerCase(),i==="ucs2"||i==="ucs-2"||i==="utf16le"||i==="utf-16le")){if(r.length<2||e.length<2)return-1;h=2,a/=2,w/=2,t/=2}function E(_,m){return h===1?_[m]:_.readUInt16BE(m*h)}let I;if(f){let _=-1;for(I=t;I<a;I++)if(E(r,I)===E(e,_===-1?0:I-_)){if(_===-1&&(_=I),I-_+1===w)return _*h}else _!==-1&&(I-=I-_),_=-1}else for(t+w>a&&(t=a-w),I=t;I>=0;I--){let _=!0;for(let m=0;m<w;m++)if(E(r,I+m)!==E(e,m)){_=!1;break}if(_)return I}return-1}o.prototype.includes=function(e,t,i){return this.indexOf(e,t,i)!==-1},o.prototype.indexOf=function(e,t,i){return he(this,e,t,i,!0)},o.prototype.lastIndexOf=function(e,t,i){return he(this,e,t,i,!1)};function Oe(r,e,t,i){t=Number(t)||0;const f=r.length-t;i?(i=Number(i),i>f&&(i=f)):i=f;const h=e.length;i>h/2&&(i=h/2);let a;for(a=0;a<i;++a){const w=parseInt(e.substr(a*2,2),16);if(se(w))return a;r[t+a]=w}return a}function Pe(r,e,t,i){return J(ne(e,r.length-t),r,t,i)}function De(r,e,t,i){return J(Ze(e),r,t,i)}function ze(r,e,t,i){return J(xe(e),r,t,i)}function je(r,e,t,i){return J(ve(e,r.length-t),r,t,i)}o.prototype.write=function(e,t,i,f){if(t===void 0)f="utf8",i=this.length,t=0;else if(i===void 0&&typeof t=="string")f=t,i=this.length,t=0;else if(isFinite(t))t=t>>>0,isFinite(i)?(i=i>>>0,f===void 0&&(f="utf8")):(f=i,i=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const h=this.length-t;if((i===void 0||i>h)&&(i=h),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");f||(f="utf8");let a=!1;for(;;)switch(f){case"hex":return Oe(this,e,t,i);case"utf8":case"utf-8":return Pe(this,e,t,i);case"ascii":case"latin1":case"binary":return De(this,e,t,i);case"base64":return ze(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return je(this,e,t,i);default:if(a)throw new TypeError("Unknown encoding: "+f);f=(""+f).toLowerCase(),a=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Ge(r,e,t){return e===0&&t===r.length?n.fromByteArray(r):n.fromByteArray(r.slice(e,t))}function ce(r,e,t){t=Math.min(r.length,t);const i=[];let f=e;for(;f<t;){const h=r[f];let a=null,w=h>239?4:h>223?3:h>191?2:1;if(f+w<=t){let E,I,_,m;switch(w){case 1:h<128&&(a=h);break;case 2:E=r[f+1],(E&192)===128&&(m=(h&31)<<6|E&63,m>127&&(a=m));break;case 3:E=r[f+1],I=r[f+2],(E&192)===128&&(I&192)===128&&(m=(h&15)<<12|(E&63)<<6|I&63,m>2047&&(m<55296||m>57343)&&(a=m));break;case 4:E=r[f+1],I=r[f+2],_=r[f+3],(E&192)===128&&(I&192)===128&&(_&192)===128&&(m=(h&15)<<18|(E&63)<<12|(I&63)<<6|_&63,m>65535&&m<1114112&&(a=m))}}a===null?(a=65533,w=1):a>65535&&(a-=65536,i.push(a>>>10&1023|55296),a=56320|a&1023),i.push(a),f+=w}return Ye(i)}const le=4096;function Ye(r){const e=r.length;if(e<=le)return String.fromCharCode.apply(String,r);let t="",i=0;for(;i<e;)t+=String.fromCharCode.apply(String,r.slice(i,i+=le));return t}function Qe(r,e,t){let i="";t=Math.min(r.length,t);for(let f=e;f<t;++f)i+=String.fromCharCode(r[f]&127);return i}function We(r,e,t){let i="";t=Math.min(r.length,t);for(let f=e;f<t;++f)i+=String.fromCharCode(r[f]);return i}function Ve(r,e,t){const i=r.length;(!e||e<0)&&(e=0),(!t||t<0||t>i)&&(t=i);let f="";for(let h=e;h<t;++h)f+=et[r[h]];return f}function Xe(r,e,t){const i=r.slice(e,t);let f="";for(let h=0;h<i.length-1;h+=2)f+=String.fromCharCode(i[h]+i[h+1]*256);return f}o.prototype.slice=function(e,t){const i=this.length;e=~~e,t=t===void 0?i:~~t,e<0?(e+=i,e<0&&(e=0)):e>i&&(e=i),t<0?(t+=i,t<0&&(t=0)):t>i&&(t=i),t<e&&(t=e);const f=this.subarray(e,t);return Object.setPrototypeOf(f,o.prototype),f};function S(r,e,t){if(r%1!==0||r<0)throw new RangeError("offset is not uint");if(r+e>t)throw new RangeError("Trying to access beyond buffer length")}o.prototype.readUintLE=o.prototype.readUIntLE=function(e,t,i){e=e>>>0,t=t>>>0,i||S(e,t,this.length);let f=this[e],h=1,a=0;for(;++a<t&&(h*=256);)f+=this[e+a]*h;return f},o.prototype.readUintBE=o.prototype.readUIntBE=function(e,t,i){e=e>>>0,t=t>>>0,i||S(e,t,this.length);let f=this[e+--t],h=1;for(;t>0&&(h*=256);)f+=this[e+--t]*h;return f},o.prototype.readUint8=o.prototype.readUInt8=function(e,t){return e=e>>>0,t||S(e,1,this.length),this[e]},o.prototype.readUint16LE=o.prototype.readUInt16LE=function(e,t){return e=e>>>0,t||S(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUint16BE=o.prototype.readUInt16BE=function(e,t){return e=e>>>0,t||S(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUint32LE=o.prototype.readUInt32LE=function(e,t){return e=e>>>0,t||S(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216},o.prototype.readUint32BE=o.prototype.readUInt32BE=function(e,t){return e=e>>>0,t||S(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readBigUInt64LE=q(function(e){e=e>>>0,j(e,"offset");const t=this[e],i=this[e+7];(t===void 0||i===void 0)&&W(e,this.length-8);const f=t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,h=this[++e]+this[++e]*2**8+this[++e]*2**16+i*2**24;return BigInt(f)+(BigInt(h)<<BigInt(32))}),o.prototype.readBigUInt64BE=q(function(e){e=e>>>0,j(e,"offset");const t=this[e],i=this[e+7];(t===void 0||i===void 0)&&W(e,this.length-8);const f=t*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],h=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+i;return(BigInt(f)<<BigInt(32))+BigInt(h)}),o.prototype.readIntLE=function(e,t,i){e=e>>>0,t=t>>>0,i||S(e,t,this.length);let f=this[e],h=1,a=0;for(;++a<t&&(h*=256);)f+=this[e+a]*h;return h*=128,f>=h&&(f-=Math.pow(2,8*t)),f},o.prototype.readIntBE=function(e,t,i){e=e>>>0,t=t>>>0,i||S(e,t,this.length);let f=t,h=1,a=this[e+--f];for(;f>0&&(h*=256);)a+=this[e+--f]*h;return h*=128,a>=h&&(a-=Math.pow(2,8*t)),a},o.prototype.readInt8=function(e,t){return e=e>>>0,t||S(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]},o.prototype.readInt16LE=function(e,t){e=e>>>0,t||S(e,2,this.length);const i=this[e]|this[e+1]<<8;return i&32768?i|4294901760:i},o.prototype.readInt16BE=function(e,t){e=e>>>0,t||S(e,2,this.length);const i=this[e+1]|this[e]<<8;return i&32768?i|4294901760:i},o.prototype.readInt32LE=function(e,t){return e=e>>>0,t||S(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return e=e>>>0,t||S(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readBigInt64LE=q(function(e){e=e>>>0,j(e,"offset");const t=this[e],i=this[e+7];(t===void 0||i===void 0)&&W(e,this.length-8);const f=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(i<<24);return(BigInt(f)<<BigInt(32))+BigInt(t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)}),o.prototype.readBigInt64BE=q(function(e){e=e>>>0,j(e,"offset");const t=this[e],i=this[e+7];(t===void 0||i===void 0)&&W(e,this.length-8);const f=(t<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(f)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+i)}),o.prototype.readFloatLE=function(e,t){return e=e>>>0,t||S(e,4,this.length),s.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return e=e>>>0,t||S(e,4,this.length),s.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return e=e>>>0,t||S(e,8,this.length),s.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return e=e>>>0,t||S(e,8,this.length),s.read(this,e,!1,52,8)};function R(r,e,t,i,f,h){if(!o.isBuffer(r))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>f||e<h)throw new RangeError('"value" argument is out of bounds');if(t+i>r.length)throw new RangeError("Index out of range")}o.prototype.writeUintLE=o.prototype.writeUIntLE=function(e,t,i,f){if(e=+e,t=t>>>0,i=i>>>0,!f){const w=Math.pow(2,8*i)-1;R(this,e,t,i,w,0)}let h=1,a=0;for(this[t]=e&255;++a<i&&(h*=256);)this[t+a]=e/h&255;return t+i},o.prototype.writeUintBE=o.prototype.writeUIntBE=function(e,t,i,f){if(e=+e,t=t>>>0,i=i>>>0,!f){const w=Math.pow(2,8*i)-1;R(this,e,t,i,w,0)}let h=i-1,a=1;for(this[t+h]=e&255;--h>=0&&(a*=256);)this[t+h]=e/a&255;return t+i},o.prototype.writeUint8=o.prototype.writeUInt8=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,1,255,0),this[t]=e&255,t+1},o.prototype.writeUint16LE=o.prototype.writeUInt16LE=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,2,65535,0),this[t]=e&255,this[t+1]=e>>>8,t+2},o.prototype.writeUint16BE=o.prototype.writeUInt16BE=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=e&255,t+2},o.prototype.writeUint32LE=o.prototype.writeUInt32LE=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=e&255,t+4},o.prototype.writeUint32BE=o.prototype.writeUInt32BE=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};function de(r,e,t,i,f){be(e,i,f,r,t,7);let h=Number(e&BigInt(4294967295));r[t++]=h,h=h>>8,r[t++]=h,h=h>>8,r[t++]=h,h=h>>8,r[t++]=h;let a=Number(e>>BigInt(32)&BigInt(4294967295));return r[t++]=a,a=a>>8,r[t++]=a,a=a>>8,r[t++]=a,a=a>>8,r[t++]=a,t}function pe(r,e,t,i,f){be(e,i,f,r,t,7);let h=Number(e&BigInt(4294967295));r[t+7]=h,h=h>>8,r[t+6]=h,h=h>>8,r[t+5]=h,h=h>>8,r[t+4]=h;let a=Number(e>>BigInt(32)&BigInt(4294967295));return r[t+3]=a,a=a>>8,r[t+2]=a,a=a>>8,r[t+1]=a,a=a>>8,r[t]=a,t+8}o.prototype.writeBigUInt64LE=q(function(e,t=0){return de(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),o.prototype.writeBigUInt64BE=q(function(e,t=0){return pe(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),o.prototype.writeIntLE=function(e,t,i,f){if(e=+e,t=t>>>0,!f){const E=Math.pow(2,8*i-1);R(this,e,t,i,E-1,-E)}let h=0,a=1,w=0;for(this[t]=e&255;++h<i&&(a*=256);)e<0&&w===0&&this[t+h-1]!==0&&(w=1),this[t+h]=(e/a>>0)-w&255;return t+i},o.prototype.writeIntBE=function(e,t,i,f){if(e=+e,t=t>>>0,!f){const E=Math.pow(2,8*i-1);R(this,e,t,i,E-1,-E)}let h=i-1,a=1,w=0;for(this[t+h]=e&255;--h>=0&&(a*=256);)e<0&&w===0&&this[t+h+1]!==0&&(w=1),this[t+h]=(e/a>>0)-w&255;return t+i},o.prototype.writeInt8=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=e&255,t+1},o.prototype.writeInt16LE=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,2,32767,-32768),this[t]=e&255,this[t+1]=e>>>8,t+2},o.prototype.writeInt16BE=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=e&255,t+2},o.prototype.writeInt32LE=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,4,2147483647,-2147483648),this[t]=e&255,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},o.prototype.writeInt32BE=function(e,t,i){return e=+e,t=t>>>0,i||R(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4},o.prototype.writeBigInt64LE=q(function(e,t=0){return de(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),o.prototype.writeBigInt64BE=q(function(e,t=0){return pe(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ye(r,e,t,i,f,h){if(t+i>r.length)throw new RangeError("Index out of range");if(t<0)throw new RangeError("Index out of range")}function we(r,e,t,i,f){return e=+e,t=t>>>0,f||ye(r,e,t,4),s.write(r,e,t,i,23,4),t+4}o.prototype.writeFloatLE=function(e,t,i){return we(this,e,t,!0,i)},o.prototype.writeFloatBE=function(e,t,i){return we(this,e,t,!1,i)};function Be(r,e,t,i,f){return e=+e,t=t>>>0,f||ye(r,e,t,8),s.write(r,e,t,i,52,8),t+8}o.prototype.writeDoubleLE=function(e,t,i){return Be(this,e,t,!0,i)},o.prototype.writeDoubleBE=function(e,t,i){return Be(this,e,t,!1,i)},o.prototype.copy=function(e,t,i,f){if(!o.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),!f&&f!==0&&(f=this.length),t>=e.length&&(t=e.length),t||(t=0),f>0&&f<i&&(f=i),f===i||e.length===0||this.length===0)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(f<0)throw new RangeError("sourceEnd out of bounds");f>this.length&&(f=this.length),e.length-t<f-i&&(f=e.length-t+i);const h=f-i;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(t,i,f):Uint8Array.prototype.set.call(e,this.subarray(i,f),t),h},o.prototype.fill=function(e,t,i,f){if(typeof e=="string"){if(typeof t=="string"?(f=t,t=0,i=this.length):typeof i=="string"&&(f=i,i=this.length),f!==void 0&&typeof f!="string")throw new TypeError("encoding must be a string");if(typeof f=="string"&&!o.isEncoding(f))throw new TypeError("Unknown encoding: "+f);if(e.length===1){const a=e.charCodeAt(0);(f==="utf8"&&a<128||f==="latin1")&&(e=a)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;t=t>>>0,i=i===void 0?this.length:i>>>0,e||(e=0);let h;if(typeof e=="number")for(h=t;h<i;++h)this[h]=e;else{const a=o.isBuffer(e)?e:o.from(e,f),w=a.length;if(w===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(h=0;h<i-t;++h)this[h+t]=a[h%w]}return this};const z={};function ie(r,e,t){z[r]=class extends t{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${r}]`,this.stack,delete this.name}get code(){return r}set code(f){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:f,writable:!0})}toString(){return`${this.name} [${r}]: ${this.message}`}}}ie("ERR_BUFFER_OUT_OF_BOUNDS",function(r){return r?`${r} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ie("ERR_INVALID_ARG_TYPE",function(r,e){return`The "${r}" argument must be of type number. Received type ${typeof e}`},TypeError),ie("ERR_OUT_OF_RANGE",function(r,e,t){let i=`The value of "${r}" is out of range.`,f=t;return Number.isInteger(t)&&Math.abs(t)>2**32?f=ge(String(t)):typeof t=="bigint"&&(f=String(t),(t>BigInt(2)**BigInt(32)||t<-(BigInt(2)**BigInt(32)))&&(f=ge(f)),f+="n"),i+=` It must be ${e}. Received ${f}`,i},RangeError);function ge(r){let e="",t=r.length;const i=r[0]==="-"?1:0;for(;t>=i+4;t-=3)e=`_${r.slice(t-3,t)}${e}`;return`${r.slice(0,t)}${e}`}function Ke(r,e,t){j(e,"offset"),(r[e]===void 0||r[e+t]===void 0)&&W(e,r.length-(t+1))}function be(r,e,t,i,f,h){if(r>t||r<e){const a=typeof e=="bigint"?"n":"";let w;throw e===0||e===BigInt(0)?w=`>= 0${a} and < 2${a} ** ${(h+1)*8}${a}`:w=`>= -(2${a} ** ${(h+1)*8-1}${a}) and < 2 ** ${(h+1)*8-1}${a}`,new z.ERR_OUT_OF_RANGE("value",w,r)}Ke(i,f,h)}function j(r,e){if(typeof r!="number")throw new z.ERR_INVALID_ARG_TYPE(e,"number",r)}function W(r,e,t){throw Math.floor(r)!==r?(j(r,t),new z.ERR_OUT_OF_RANGE("offset","an integer",r)):e<0?new z.ERR_BUFFER_OUT_OF_BOUNDS:new z.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,r)}const He=/[^+/0-9A-Za-z-_]/g;function Je(r){if(r=r.split("=")[0],r=r.trim().replace(He,""),r.length<2)return"";for(;r.length%4!==0;)r=r+"=";return r}function ne(r,e){e=e||1/0;let t;const i=r.length;let f=null;const h=[];for(let a=0;a<i;++a){if(t=r.charCodeAt(a),t>55295&&t<57344){if(!f){if(t>56319){(e-=3)>-1&&h.push(239,191,189);continue}else if(a+1===i){(e-=3)>-1&&h.push(239,191,189);continue}f=t;continue}if(t<56320){(e-=3)>-1&&h.push(239,191,189),f=t;continue}t=(f-55296<<10|t-56320)+65536}else f&&(e-=3)>-1&&h.push(239,191,189);if(f=null,t<128){if((e-=1)<0)break;h.push(t)}else if(t<2048){if((e-=2)<0)break;h.push(t>>6|192,t&63|128)}else if(t<65536){if((e-=3)<0)break;h.push(t>>12|224,t>>6&63|128,t&63|128)}else if(t<1114112){if((e-=4)<0)break;h.push(t>>18|240,t>>12&63|128,t>>6&63|128,t&63|128)}else throw new Error("Invalid code point")}return h}function Ze(r){const e=[];for(let t=0;t<r.length;++t)e.push(r.charCodeAt(t)&255);return e}function ve(r,e){let t,i,f;const h=[];for(let a=0;a<r.length&&!((e-=2)<0);++a)t=r.charCodeAt(a),i=t>>8,f=t%256,h.push(f),h.push(i);return h}function xe(r){return n.toByteArray(Je(r))}function J(r,e,t,i){let f;for(f=0;f<i&&!(f+t>=e.length||f>=r.length);++f)e[f+t]=r[f];return f}function N(r,e){return r instanceof e||r!=null&&r.constructor!=null&&r.constructor.name!=null&&r.constructor.name===e.name}function se(r){return r!==r}const et=function(){const r="0123456789abcdef",e=new Array(256);for(let t=0;t<16;++t){const i=t*16;for(let f=0;f<16;++f)e[i+f]=r[t]+r[f]}return e}();function q(r){return typeof BigInt>"u"?tt:r}function tt(){throw new Error("BigInt not supported")}})(X);class Re{constructor(){B(this,"buffer",new Uint8Array(0))}write(n){let s=new Uint8Array(this.buffer.length+n.length);s.set(this.buffer),s.set(n,this.buffer.length),this.buffer=s}}class ke{constructor(n,s=1){B(this,"pendingByte",BigInt(0));B(this,"pendingBits",0);B(this,"buffer");B(this,"bufferedBytes",0);B(this,"_offset",0);this.stream=n,this.bufferSize=s,this.buffer=new Uint8Array(s)}get offset(){return this._offset}get byteOffset(){return this.pendingBits}end(){this.finishByte(),this.flush()}reset(){this._offset=0}finishByte(){this.pendingBits>0&&(this.buffer[this.bufferedBytes++]=Number(this.pendingByte),this.pendingBits=0,this.pendingByte=BigInt(0))}flush(){this.bufferedBytes>0&&(this.stream.write(X.Buffer.from(this.buffer.slice(0,this.bufferedBytes))),this.bufferedBytes=0)}min(n,s){return n<s?n:s}write(n,s){if(s==null&&(s=0),s=Number(s),Number.isNaN(s))throw new Error(`Cannot write to bitstream: Value ${s} is not a number`);if(!Number.isFinite(s))throw new Error(`Cannot write to bitstream: Value ${s} must be finite`);let u=BigInt(s%Math.pow(2,n)),c=n;for(;c>0;){let l=BigInt(8-this.pendingBits-c),d=l>=0?u<<l:u>>-l,o=Number(l>=0?c:this.min(-l,BigInt(8-this.pendingBits)));this.pendingByte=this.pendingByte|d,this.pendingBits+=o,this._offset+=o,c-=o,u=u%BigInt(Math.pow(2,c)),this.pendingBits===8&&(this.finishByte(),this.bufferedBytes>=this.buffer.length&&this.flush())}}}let H;class Le{constructor(){B(this,"buffers",[]);B(this,"bufferedLength",0);B(this,"blockedRequest",null);B(this,"_offsetIntoBuffer",0);B(this,"_bufferIndex",0);B(this,"_offset",0);B(this,"_spentBufferSize",0);B(this,"retainBuffers",!1);B(this,"textDecoder",new TextDecoder);B(this,"skippedLength",0);B(this,"_ended",!1)}get bufferIndex(){return this._bufferIndex}get offset(){return this._offset}get spentBufferSize(){return this._spentBufferSize}set offset(n){if(n<this._spentBufferSize)throw new Error(`Offset ${n} points into a discarded buffer! If you need to seek backwards outside the current buffer, make sure to set retainBuffers=true`);let s=n-this._spentBufferSize,u=0;for(let c=0,l=this.buffers.length;c<l;++c){let d=this.buffers[c],o=d.length*8;if(s<o){this._bufferIndex=u,this._offset=n,this._offsetIntoBuffer=s,this.bufferedLength=d.length*8-this._offsetIntoBuffer;for(let y=c+1;y<l;++y)this.bufferedLength+=this.buffers[y].length*8;return}s-=o,++u}}simulateSync(n){let s=this.retainBuffers,u=this.offset;this.retainBuffers=!0;try{return n()}finally{this.retainBuffers=s,this.offset=u}}async simulate(n){let s=this.retainBuffers,u=this.offset;this.retainBuffers=!0;try{return await n()}finally{this.retainBuffers=s,this.offset=u}}clean(n){let s=n!==void 0?Math.min(n,this._bufferIndex):this._bufferIndex;for(let u=0,c=s;u<c;++u)this._spentBufferSize+=this.buffers[0].length*8,this.buffers.shift();this._bufferIndex-=s}get available(){return this.bufferedLength-this.skippedLength}isAvailable(n){return this.bufferedLength>=n}ensureNoReadPending(){if(this.blockedRequest)throw new Error("Only one read() can be outstanding at a time.")}async readString(n,s){return this.ensureNoReadPending(),await this.assure(8*n),this.readStringSync(n,s)}readStringSync(n,s){s||(s={}),this.ensureNoReadPending();let u=new Uint8Array(n),c=-1,l=1,d=s.encoding??"utf-8";["utf16le","ucs-2","ucs2"].includes(d)&&(l=2);for(let o=0,y=n;o<y;++o)u[o]=this.readSync(8);for(let o=0,y=n;o<y;o+=l){let b=u[o];if(l===2&&(b=b<<8|(u[o+1]??0)),b===0){c=o;break}}if(s.nullTerminated!==!1&&c>=0&&(u=u.subarray(0,c)),d==="utf-8")return this.textDecoder.decode(u);if(typeof Buffer>"u")throw new Error(`Encoding '${d}' is not supported: No Node.js Buffer implementation and TextDecoder only supports utf-8`);return Buffer.from(u).toString(d)}peekSync(n){return this.readCoreSync(n,!1)}skip(n){this.skippedLength+=n}readSync(n){return this.readCoreSync(n,!0)}*readBytes(n,s=0,u){var l;if(u??(u=n.length-s),this._offsetIntoBuffer%8===0){globalThis.BITSTREAM_TRACE&&(console.log(`------------------------------------------------------------    Byte-aligned readBytes(), length=${u}`),console.log(`------------------------------------------------------------    readBytes(): Pre-operation: buffered=${this.bufferedLength} bits, bufferIndex=${this._bufferIndex}, bufferOffset=${this._offsetIntoBuffer}, bufferLength=${((l=this.buffers[this._bufferIndex])==null?void 0:l.length)||"<none>"} bufferCount=${this.buffers.length}`));let d=u,o=0;for(;d>0;){this.available<d*8&&(yield Math.max((d*8-this.available)/8));let y=Math.floor(this._offsetIntoBuffer/8),b=this.buffers[this._bufferIndex],x=Math.min(d,b.length);for(let A=0;A<x;++A)n[o+A]=b[y+A];o+=x;let g=x*8;this.consume(g),d-=g,globalThis.BITSTREAM_TRACE&&(console.log(`------------------------------------------------------------    readBytes(): consumed=${x} bytes, remaining=${d}`),console.log(`------------------------------------------------------------    readBytes(): buffered=${this.bufferedLength} bits, bufferIndex=${this._bufferIndex}, bufferOffset=${this._offsetIntoBuffer}, bufferCount=${this.buffers.length}`))}}else for(let d=s,o=Math.min(n.length,s+u);d<o;++d)this.isAvailable(8)||(yield o-d),n[d]=this.readSync(8);return n}readBytesSync(n,s=0,u){u??(u=n.length-s);let c=this.readBytes(n,s,u);for(;;){if(c.next().done===!1)throw new Error(`underrun: Not enough bits are available (requested ${u} bytes)`);break}return n}async readBytesBlocking(n,s=0,u){u??(u=n.length-s);let c=this.readBytes(n,s,u);for(;;){let l=c.next();if(l.done===!1)await this.assure(l.value*8);else break}return n}readSignedSync(n){const s=this.readSync(n),u=2**(n-1),c=u-1;return s&u?-((~(s-1)&c)>>>0):s}maskOf(n){if(!H){H=new Map;for(let s=0;s<=64;++s)H.set(s,Math.pow(2,s)-1)}return H.get(n)??Math.pow(2,n)-1}readFloatSync(n){if(n!==32&&n!==64)throw new TypeError(`Invalid length (${n} bits) Only 4-byte (32 bit / single-precision) and 8-byte (64 bit / double-precision) IEEE 754 values are supported`);if(!this.isAvailable(n))throw new Error(`underrun: Not enough bits are available (requested=${n}, available=${this.bufferedLength}, buffers=${this.buffers.length})`);let s=new ArrayBuffer(n/8),u=new DataView(s);for(let c=0,l=s.byteLength;c<l;++c)u.setUint8(c,this.readSync(8));if(n===32)return u.getFloat32(0,!1);if(n===64)return u.getFloat64(0,!1)}readByteAligned(n){let s=this.buffers[this._bufferIndex],u=s[this._offsetIntoBuffer/8];return n&&(this.bufferedLength-=8,this._offsetIntoBuffer+=8,this._offset+=8,this._offsetIntoBuffer>=s.length*8&&(this._bufferIndex+=1,this._offsetIntoBuffer=0,this.retainBuffers||this.clean())),u}consume(n){this.bufferedLength-=n,this._offsetIntoBuffer+=n,this._offset+=n;let s=this.buffers[this._bufferIndex];for(;s&&this._offsetIntoBuffer>=s.length*8;)this._bufferIndex+=1,this._offsetIntoBuffer-=s.length*8,s=this.buffers[this._bufferIndex],this.retainBuffers||this.clean()}readShortByteAligned(n,s){let u=this.buffers[this._bufferIndex],c=this._offsetIntoBuffer/8,l=u[c],d;if(c+1>=u.length?d=this.buffers[this._bufferIndex+1][0]:d=u[c+1],n&&this.consume(16),s==="lsb"){let o=l;l=d,d=o}return l<<8|d}readLongByteAligned(n,s){let u=this._bufferIndex,c=this.buffers[u],l=this._offsetIntoBuffer/8,d=c[l++];l>=c.length&&(c=this.buffers[++u],l=0);let o=c[l++];l>=c.length&&(c=this.buffers[++u],l=0);let y=c[l++];l>=c.length&&(c=this.buffers[++u],l=0);let b=c[l++];l>=c.length&&(c=this.buffers[++u],l=0),n&&this.consume(32);let x=(d&128)!==0;if(d&=-129,s==="lsb"){let A=b,U=y,C=o,M=d;d=A,o=U,y=C,b=M}let g=d<<24|o<<16|y<<8|b;return x&&(g+=2**31),g}read3ByteAligned(n,s){let u=this._bufferIndex,c=this.buffers[u],l=this._offsetIntoBuffer/8,d=c[l++];l>=c.length&&(c=this.buffers[++u],l=0);let o=c[l++];l>=c.length&&(c=this.buffers[++u],l=0);let y=c[l++];if(l>=c.length&&(c=this.buffers[++u],l=0),n&&this.consume(24),s==="lsb"){let b=d;d=y,y=b}return d<<16|o<<8|y}readPartialByte(n,s){let c=this.buffers[this._bufferIndex][Math.floor(this._offsetIntoBuffer/8)],l=this._offsetIntoBuffer%8|0;return s&&this.consume(n),c>>8-n-l&this.maskOf(n)|0}readCoreSync(n,s,u="msb"){if(this.ensureNoReadPending(),this.available<n)throw new Error(`underrun: Not enough bits are available (requested=${n}, available=${this.bufferedLength}, buffers=${this.buffers.length})`);this.adjustSkip();let c=this._offsetIntoBuffer%8;if(c===0){if(n===8)return this.readByteAligned(s);if(n===16)return this.readShortByteAligned(s,u);if(n===24)return this.read3ByteAligned(s,u);if(n===32)return this.readLongByteAligned(s,u)}if(n<8&&(8-c|0)>=n)return this.readPartialByte(n,s);let l=n,d=this._offsetIntoBuffer,o=this._bufferIndex,y=BigInt(0),b=0,x=n>31;for(;l>0;){if(o>=this.buffers.length)throw new Error(`Internal error: Buffer index out of range (index=${o}, count=${this.buffers.length}), offset=${this.offset}, readLength=${n}, available=${this.available})`);let g=this.buffers[o],A=Math.floor(d/8);if(A>=g.length)throw new Error(`Internal error: Current buffer (index ${o}) has length ${g.length} but our position within the buffer is ${A}! offset=${this.offset}, bufs=${this.buffers.length}`);let U=d%8,C,M=g[A];C=Math.min(8-U,l),x?y=y<<BigInt(C)|BigInt(g[A])>>BigInt(8)-BigInt(C)-BigInt(U)&BigInt(this.maskOf(C)):b=b<<C|M>>8-C-U&this.maskOf(C),d+=C,l-=C|0,d>=g.length*8&&(o+=1,d=0)}return s&&this.consume(n),x?Number(y):b}adjustSkip(){if(!(this.skippedLength<=0)){for(;this.buffers&&this.skippedLength>this.buffers[0].length*8-this._offsetIntoBuffer;)this.skippedLength-=this.buffers[0].length*8-this._offsetIntoBuffer,this._offsetIntoBuffer=0,this.buffers.shift();this.buffers.length>0&&(this._offsetIntoBuffer+=this.skippedLength,this.skippedLength=0)}}assure(n,s=!1){return this.ensureNoReadPending(),this.bufferedLength>=n?Promise.resolve():this.block({length:n,assure:!0}).then(u=>{if(u<n&&!s)throw this.endOfStreamError(n)})}read(n){return this.ensureNoReadPending(),this.available>=n?Promise.resolve(this.readSync(n)):this.block({length:n})}readSigned(n){return this.ensureNoReadPending(),this.available>=n?Promise.resolve(this.readSignedSync(n)):this.block({length:n,signed:!0})}promise(){let n,s;return{promise:new Promise((c,l)=>(n=c,s=l)),resolve:n,reject:s}}block(n){return this._ended?n.assure?Promise.resolve(this.available):Promise.reject(this.endOfStreamError(n.length)):(this.blockedRequest={...n,...this.promise()},this.blockedRequest.promise)}readFloat(n){return this.ensureNoReadPending(),this.available>=n?Promise.resolve(this.readFloatSync(n)):this.block({length:n,float:!0})}async peek(n){return await this.assure(n),this.peekSync(n)}addBuffer(n){if(this._ended)throw new Error("Cannot add buffers to a reader which has been marked as ended without calling reset() first");if(this.buffers.push(n),this.bufferedLength+=n.length*8,this.blockedRequest&&this.blockedRequest.length<=this.available){let s=this.blockedRequest;this.blockedRequest=null,s.assure?s.resolve(s.length):s.signed?s.resolve(this.readSignedSync(s.length)):s.float?s.resolve(this.readFloatSync(s.length)):s.resolve(this.readSync(s.length))}}get ended(){return this._ended}reset(){if(this.blockedRequest)throw new Error("Cannot reset while there is a blocked request!");this.buffers=[],this.bufferedLength=0,this.blockedRequest=null,this._offsetIntoBuffer=0,this._bufferIndex=0,this._offset=0,this._spentBufferSize=0,this._ended=!1}end(){if(this._ended=!0,this.blockedRequest){let n=this.blockedRequest;if(this.blockedRequest=null,n.length<=this.available)throw new Error("Internal inconsistency in @/bitstream: Should have granted request prior. Please report this bug.");n.assure?n.resolve(this.available):n.reject(this.endOfStreamError(n.length))}}endOfStreamError(n){return new Error(`End of stream reached while reading ${n} bits, only ${this.available} bits are left in the stream`)}}function Te(p){const s=p.split(`
`).flatMap(d=>{const o=d.trim().match(/^(\d+) (\w+)$/);return o&&parseInt(o[1],10)>0?[{quantity:parseInt(o[1],10),id:o[2]}]:[]}),u=new Re,c=new ke(u,1024);return P.fromList(s).encode(c),c.end(),X.Buffer.concat([u.buffer]).toString("base64")}function $e(p){const n=X.Buffer.from(p,"base64");let s=new Le;return s.addBuffer(n),P.decode(s).asCardRefQty.map(l=>`${l.quantity} ${l.id}`).join(`
`)}k.decodeList=$e,k.encodeList=Te,Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});
